name: CI â€“ Lint & Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - poi-service
          - asset-service
          - script-service
          - transcription-service
          - render-service
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install tools
        run: pip install ruff black mypy

      - name: Install service deps (for mypy)
        run: |
          pip install ./libs/contracts ./libs/common
          cd services/${{ matrix.service }}
          pip install ".[dev]" 2>/dev/null || pip install . 2>/dev/null || true

      - name: Lint ${{ matrix.service }}
        run: |
          cd services/${{ matrix.service }}
          ruff check .
          black --check .
          mypy app/ --ignore-missing-imports --no-error-summary

  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        service:
          - poi-service
          - asset-service
          - script-service
          - transcription-service
          - render-service
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install ./libs/contracts ./libs/common
          cd services/${{ matrix.service }}
          pip install ".[dev]" 2>/dev/null || pip install .
          pip install pytest pytest-asyncio httpx

      - name: Run tests for ${{ matrix.service }}
        run: |
          cd services/${{ matrix.service }}
          python -m pytest tests/ -v --tb=short
        env:
          POSTGRES_HOST: ""
          POSTGRES_DB: ""
          API_KEY: test-key
          LOG_FORMAT: text
          RUNWAY_MODE: stub
          NLP_PROVIDER: stub

